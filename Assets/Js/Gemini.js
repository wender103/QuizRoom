const apiKey = 'AIzaSyCPOgQxs2HeishfhsEvo548lrmj8jEJNl0'
const siteUrl = 'https://wender103.github.io/QuizRoom/'
const siteName = 'Chat com IA'


async function Enviar_Prompt(userMessage) {
    if (!userMessage) return

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                contents: [
                    {
                        parts: [{ text: userMessage }]
                    }
                ]
            })
        })

        if (!response.ok) {
            throw new Error(`Erro ${response.status}: ${response.statusText}`)
        }

        const data = await response.json()
        const aiMessage = data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro ao processar resposta."
        return aiMessage
    } catch (error) {
        alert(`Erro: ${error.message} üòî`)
        console.error(error)
    }
}

const Container_Pag_Quiz = document.getElementById('Container_Pag_Quiz')
const p_Pergunta = document.getElementById('p_Pergunta')
const Container_Alternativas = document.getElementById('Container_Alternativas')
let Respondido = false
function Parse_Question(text) {
    // Determina qual termo est√° presente: "Resposta correta" ou "Alternativa correta"
    const separator = text.includes('Resposta correta:') 
        ? 'Resposta correta:' 
        : text.includes('Alternativa correta:') 
        ? 'Alternativa correta:' 
        : null

    if (!separator) {
        throw new Error('O texto n√£o cont√©m os separadores esperados: "Resposta correta:" ou "Alternativa correta:"')
    }

    // Separa a pergunta e alternativas da resposta correta
    const parts = text.split(separator)

    // A primeira parte cont√©m a pergunta e as alternativas
    const questionAndAlternatives = parts[0]?.trim() || ''
    const resposta = parts[1]?.trim() || ''

    // Verifica se questionAndAlternatives e resposta existem
    if (!questionAndAlternatives || !resposta) {
        throw new Error('O texto fornecido n√£o cont√©m as partes esperadas.')
    }

    // Extrai a pergunta antes do primeiro "?"
    const pergunta = questionAndAlternatives.split('?')[0]?.trim() + '?'

    // Extrai as alternativas ap√≥s o "?"
    const alternativasRaw = questionAndAlternatives.split('?')[1]?.trim()
    if (!alternativasRaw) {
        throw new Error('As alternativas n√£o foram encontradas no texto.')
    }

    // Divide as alternativas em linhas, limpa espa√ßos e remove vazios
    const alternativas = alternativasRaw
        .split('\n') // Divide por linhas
        .map(alt => alt.trim()) // Remove espa√ßos extras
        .filter(alt => alt) // Remove linhas vazias

    // Retorna o objeto final
    return {
        Pergunta: pergunta,
        Alternativas: alternativas,
        Resposta: resposta
    }
}

function Contar_Acertos() {
    const { Jogadores, Quiz } = Sala_Atual
    const respostaCerta = Quiz.Resposta
    const numeroPergunta = Quiz.Numero_Da_Pergunta

    // Conta os jogadores que acertaram a resposta
    const totalAcertos = Jogadores.filter(jogador => jogador.Respostas[numeroPergunta] === respostaCerta).length + 1

    return totalAcertos
}

function Ativar_Quiz(Novo_Quiz) {
    
    Respondido = false
    Container_Pag_Quiz.classList.remove('Active')



    p_Pergunta.innerText = Novo_Quiz.Pergunta
    Container_Alternativas.innerHTML = ''

    for (let i = 0; i < Novo_Quiz.Alternativas.length; i++) {
        const alternativa = Novo_Quiz.Alternativas[i]
        const button = document.createElement('button')
        const Container_Imgs_Users_Alternativas = document.createElement('div')
        Container_Imgs_Users_Alternativas.className = 'Container_Imgs_Users_Alternativas'
        const p = document.createElement('p')
        p.innerText = alternativa
        button.appendChild(Container_Imgs_Users_Alternativas)
        button.appendChild(p)
        button.classList.add('Btn_Padrao')
        button.classList.add('Btn_Alternativas')
        button.id = 'Btn_Alternativa_' + i
        Container_Alternativas.appendChild(button)

        // Adiciona um evento de clique ao bot√£o
        button.addEventListener('click', () => {
            if(!Respondido) {
                button.classList.add('Active')
                
                if (alternativa === Novo_Quiz.Resposta) {
                    for (let c = 0; c < Sala_Atual.Jogadores.length; c++) {
                        if(Sala_Atual.Jogadores[c].Email === Usuario.email) {
                            if(Contar_Acertos() > 0) {
                                
                                Sala_Atual.Jogadores[c].Pontos += parseInt(100 / Contar_Acertos())
                            } else {
                                
                                Sala_Atual.Jogadores[c].Pontos += 100
                            }
                            
                            Sala_Atual.Jogadores[c].Respostas[Novo_Quiz.Numero_Da_Pergunta] = alternativa

                            

                            if(Sala_Atual.Quiz.Numero_Da_Pergunta > 0 && Sala_Atual.Jogadores[c].Respostas[Sala_Atual.Quiz.Numero_Da_Pergunta - 1] === undefined) {
                                Sala_Atual.Jogadores[c].Respostas[Sala_Atual.Quiz.Numero_Da_Pergunta - 1] == '#@$@$@$@#$@'
                            }
                            break
                        }
                    }

                } else {
                    for (let c = 0; c < Sala_Atual.Jogadores.length; c++) {
                        if(Sala_Atual.Jogadores[c].Email === Usuario.email) {
                            Sala_Atual.Jogadores[c].Pontos += 0
                            Sala_Atual.Jogadores[c].Respostas[Novo_Quiz.Numero_Da_Pergunta] = alternativa
                            break
                        }
                    }
                }

                const Btns = document.querySelectorAll('.Btn_Alternativas')
                for (let c = 0; c < Btns.length; c++) { 
                
                    if(Btns[c].id !== button.id) {
                        Btns[c].classList.remove('Active')
                        Btns[c].classList.add('Blocked')
                    }
                }

                Respondido = true
                db.collection('Salas_QuizRoom').doc(Sala_Atual.Criador).update({  
                    Jogadores: Sala_Atual.Jogadores
                })
            }
        })
    }
    Start_Countdown(Novo_Quiz.Time)
}

function Comecar_Quiz() {
    if(Sala_Atual.Estado != 'Jogando') {
        Sala_Atual.Estado = 'Jogando'

        db.collection('Salas_QuizRoom').doc(Sala_Atual.Criador).update({  
            Estado: Sala_Atual.Estado
        }).then(() => {
            Perguntar()
        })
    } else {
        Perguntar()
    }

    async function Perguntar() {
        if(Sala_Atual.Quiz.Numero_Da_Pergunta < Sala_Atual.Quiz.Max_Perguntas) {
            try {                
                const variacaoContexto = Date.now()
                const enfoquesPorDificuldade = {
                facil: ['conceito b√°sico', 'exemplo cotidiano', 'identifica√ß√£o visual', 'fun√ß√£o principal'],
                medio: ['aplica√ß√£o pr√°tica', 'compara√ß√£o simples', 'contexto hist√≥rico', 'termo t√©cnico'],
                dificil: ['mecanismo interno', 'an√°lise cr√≠tica', 'exce√ß√£o not√°vel', 'detalhe avan√ßado'],
                expert: ['cen√°rio hipot√©tico', 'solu√ß√£o n√£o trivial', 'dados espec√≠ficos', 'integra√ß√£o multidisciplinar']
                }

                const angulosPorDificuldade = {
                facil: ['o que √©', 'para que serve', 'onde encontramos', 'exemplo simples'],
                medio: ['como funciona', 'diferen√ßas b√°sicas', 'quando surgiu', 'problemas comuns'],
                dificil: ['por que ocorre', 'consequ√™ncias complexas', 'limita√ß√µes', 'otimiza√ß√µes'],
                expert: ['cr√≠ticas especializadas', 'solu√ß√µes alternativas', 'an√°lise quantitativa', 'tend√™ncias futuras']
                }

                const Resposta = await Enviar_Prompt(
                    `Crie uma pergunta de m√∫ltipla escolha √öNICA com:

                    PAR√ÇMETROS-CHAVE:
                    ‚Ä¢ Tema: "${Sala_Atual.Tema}"
                    ‚Ä¢ Dificuldade: ${Sala_Atual.Quiz.Dificuldade}
                    ‚Ä¢ Alternativas: ${Sala_Atual.Quiz.Max_Alternativas} (UMA correta)
                    ‚Ä¢ Contexto √∫nico: ${variacaoContexto}

                    DIRETRIZES POR DIFICULDADE:
                    ${Sala_Atual.Quiz.Dificuldade === 'facil' ? 
                    "- Use linguagem acess√≠vel\n- Foque em reconhecimento\n- Alternativas com erros √≥bvios (para iniciantes)" :
                    Sala_Atual.Quiz.Dificuldade === 'medio' ?
                    "- Exija compreens√£o b√°sica\n- Inclua 1-2 termos t√©cnicos\n- Erros sutis nas alternativas" :
                    Sala_Atual.Quiz.Dificuldade === 'dificil' ?
                    "- Requira conhecimento aplicado\n- Use casos espec√≠ficos\n- Alternativas com meias-verdades" :
                    "- Desafie especialistas\n- Inclua dados precisos\n- Alternativas com armadilhas sofisticadas"}

                    ESTRUTURA CRIATIVA:
                    ‚Ä¢ Enfoque: ${enfoquesPorDificuldade[Sala_Atual.Quiz.Dificuldade].sort(() => 0.5 - Math.random())[0]}
                    ‚Ä¢ √Çngulo: ${angulosPorDificuldade[Sala_Atual.Quiz.Dificuldade].sort(() => 0.5 - Math.random())[0]}
                    ${Sala_Atual.Quiz.Dificuldade === 'expert' ? '‚Ä¢ Inclua: ' + ['f√≥rmula relevante', 'dado estat√≠stico', 'caso de estudo real', 'cita√ß√£o t√©cnica'].sort(() => 0.5 - Math.random())[0] : ''}

                    FORMATO EXIGIDO:
                    Pergunta: [Texto completo com complexidade adequada ao n√≠vel ${Sala_Atual.Quiz.Dificuldade}]

                    ${Array.from({length: Sala_Atual.Quiz.Max_Alternativas}, (_, i) => 
                    `${String.fromCharCode(97 + i)}) [Alternativa ${String.fromCharCode(65 + i)} - ${Sala_Atual.Quiz.Dificuldade === 'facil' ? 'erro claro' : 
                        Sala_Atual.Quiz.Dificuldade === 'expert' ? 'armadilha especializada' : 'distrator plaus√≠vel'}]`).join('\n')}

                    Alternativa correta: [letra]) [Resposta tecnicamente precisa]

                    EXEMPLO ${Sala_Atual.Quiz.Dificuldade.toUpperCase()}:
                    Pergunta: ${Sala_Atual.Quiz.Dificuldade === 'facil' ? 
                    `Qual destes √© um componente b√°sico de ${Sala_Atual.Tema.includes('redes') ? 'uma rede de computadores?' : 'um sistema operacional?'}` :
                    Sala_Atual.Quiz.Dificuldade === 'expert' ?
                    `Considerando a equa√ß√£o ${Sala_Atual.Tema.includes('f√≠sica') ? 'de Schr√∂dinger' : 'de Black-Scholes'}, qual par√¢metro tem maior impacto em ${Sala_Atual.Tema.includes('f√≠sica') ? 'decoer√™ncia qu√¢ntica' : 'hedge delta-neutral'}?` :
                    `Em ${Sala_Atual.Tema.includes('programa√ß√£o') ? 'OOP' : 'gest√£o √°gil'}, qual princ√≠pio ${Sala_Atual.Tema.includes('programa√ß√£o') ? 'determina encapsulamento?' : 'prioriza entrega cont√≠nua?'}`}

                    ${Array.from({length: Sala_Atual.Quiz.Max_Alternativas}, (_, i) => 
                    `${String.fromCharCode(97 + i)}) ${gerarExemploAlternativa(Sala_Atual)}`).join('\n')}

                    Alternativa correta: ${Sala_Atual.Quiz.Dificuldade === 'facil' ? 'a) ' + (Sala_Atual.Tema.includes('redes') ? 'Roteador' : 'Kernel') :
                                        Sala_Atual.Quiz.Dificuldade === 'expert' ? 'c) ' + (Sala_Atual.Tema.includes('f√≠sica') ? 'Constante de Planck reduzida' : 'Volatilidade impl√≠cita') :
                                        'b) ' + (Sala_Atual.Tema.includes('programa√ß√£o') ? 'Modificadores de acesso' : 'Princ√≠pio de Pareto')}`
                )

                // Fun√ß√£o auxiliar para exemplos (simulada)
                function gerarExemploAlternativa(sala) {
                const temas = {
                    redes: ['Switch', 'Firewall', 'DNS', 'Cache CDN'],
                    programa√ß√£o: ['Heran√ßa', 'Polimorfismo', 'Coes√£o', 'Acoplamento'],
                    f√≠sica: ['Massa', 'Carga el√©trica', 'Spin', 'Superposi√ß√£o']
                }
                const t = Object.keys(temas).find(k => sala.Tema.includes(k)) || 'programa√ß√£o'
                return temas[t][Math.floor(Math.random() * temas[t].length)]
                }

                const Resposta_Formatada = Parse_Question(Resposta)

                let Time_Sala = Sala_Atual.Quiz.Intervalo_Questao

                // Aqui voc√™ pode processar a resposta
                Sala_Atual.Quiz.Pergunta = Resposta_Formatada.Pergunta
                Sala_Atual.Quiz.Alternativas = Resposta_Formatada.Alternativas
                Sala_Atual.Quiz.Resposta = Resposta_Formatada.Resposta
                Sala_Atual.Quiz.Numero_Da_Pergunta = Sala_Atual.Quiz.Numero_Da_Pergunta + 1
                Sala_Atual.Quiz.Time = Adicionar_Hora(Time_Sala.Horas, Time_Sala.Minutos, Time_Sala.Segundos)

                db.collection('Salas_QuizRoom').doc(Sala_Atual.Criador).update({  
                    Quiz: Sala_Atual.Quiz
                }).then(() => {
                    Ativar_Quiz(Sala_Atual.Quiz)
                })

            } catch (error) {
                console.error('Erro ao gerar o quiz:', error)
            }
        }
    }
}